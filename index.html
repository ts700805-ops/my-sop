<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>SOP 雲端同步系統</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALcGIGqqTDg47FjSg9cy1Ld19C7WgA29Y",
            authDomain: "sop-ta-liang.firebaseapp.com",
            projectId: "sop-ta-liang",
            storageBucket: "sop-ta-liang.firebasestorage.app",
            messagingSenderId: "776894564311",
            appId: "1:776894564311:web:ee70e633865b5f946e2d92",
            measurementId: "G-1EHKPL1K6R"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const sopRef = doc(db, "data", "allSOPs");

        // 全域變數
        window.allSOPs = {};
        window.currentSOPKey = "";
        window.userRole = "";

        // --- 1. 雲端同步與監聽邏輯 ---
        onSnapshot(sopRef, (docSnap) => {
            if (docSnap.exists()) {
                window.allSOPs = docSnap.data().content || {};
                if (document.getElementById('mainMenu').style.display === 'block') {
                    window.renderSOPButtons();
                }
            }
        });

        // 核心儲存函數：確保一定會等待雲端回應
        window.saveToCloud = async function() {
            try {
                await setDoc(sopRef, { content: window.allSOPs });
                console.log("雲端同步成功");
                return true;
            } catch (e) {
                console.error("儲存失敗:", e);
                alert("雲端儲存失敗！請檢查 Firebase 規則是否已開啟為測試模式。");
                return false;
            }
        };

        // --- 2. 登入與導覽邏輯 ---
        window.handleLogin = function() {
            const pass = document.getElementById('passInput').value;
            if (pass === "0000") { window.userRole = "admin"; window.showMainMenu(); }
            else if (pass === "1234") { window.userRole = "viewer"; window.showMainMenu(); }
            else { alert("密碼錯誤"); }
        };

        window.showMainMenu = function() {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('editArea').style.display = 'none';
            document.getElementById('teachingMode').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('adminTools').style.display = (window.userRole === "admin") ? 'block' : 'none';
            window.renderSOPButtons();
        };

        // 按下「儲存並返回」時專用的函數
        window.saveAndExit = async function() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "正在儲存到雲端，請稍候...";
            btn.disabled = true;

            const success = await window.saveTo
