<script type="module">
    // ... (保持原本的 Firebase 初始化代碼不變) ...

    // 優化圖片處理，避免檔案太大導致儲存卡死
    async function processImage(file) {
        return new Promise(r => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const i = new Image();
                i.src = e.target.result;
                i.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = i.width, h = i.height;
                    // 強制限制圖片最大寬度為 600px，大幅減小體積
                    if (w > 600) { h *= 600/w; w = 600; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(i, 0, 0, w, h);
                    // 使用 0.5 的品質進一步壓縮
                    r(canvas.toDataURL('image/jpeg', 0.5));
                };
            };
            reader.readAsDataURL(file);
        });
    }

    // 儲存邏輯增加錯誤補捉
    document.getElementById('saveExitBtn').onclick = async function() {
        const btn = this;
        btn.innerText = "儲存中..."; 
        btn.disabled = true;
        
        try {
            // 在儲存前檢查資料總大小
            const dataString = JSON.stringify({ content: allSOPs });
            const sizeInBytes = new Blob([dataString]).size;
            console.log("資料大小: " + (sizeInBytes / 1024).toFixed(2) + " KB");

            if (sizeInBytes > 1000000) { // 超過 1MB 警告
                throw new Error("圖片過多或檔案太大，請刪除部分步驟或重新上傳較小的照片後再儲存。");
            }

            await setDoc(sopRef, { content: allSOPs });
            alert("儲存成功！");
            showMainMenu();
        } catch (e) {
            console.error(e);
            alert("儲存失敗！錯誤原因：" + e.message);
        } finally {
            btn.innerText = "✔ 儲存並返回目錄";
            btn.disabled = false;
        }
    };
    
    // ... (其餘功能保持不變) ...
</script>
